# USER FRIENDLY FORMAT IS HERE:
# https://studio.asyncapi.com/?share=969ab085-2900-4d76-9b4e-8e9355422e6e

asyncapi: 3.0.0
info:
  title: Smoke Detection Event Manager API
  version: 1.0.0
  description: >-
    A microservice that checks whether sensor readings exceed   predefined
    **thresholds**. If they do, it publishes a **Smoke Event** to a topic.
  license:
    name: Jovan Cvetkovic
    url: https://www.github.com/cjovan02
servers:
  production:
    host: test.mosquitto.org
    protocol: mqtt
    description: Public Mosquitto MQTT broker
channels:
  raw-readings:
    address: data-manager/raw-readings
    description: The topic on which raw sensor readings may be produced or consumed.
    messages:
      reading:
        $ref: "#/components/messages/reading"
  threshold-readings:
    address: event-manager/threshold-readings
    description: The topic on which smoke events may be produced of consumed.
    messages:
      smokeEvent:
        $ref: "#/components/messages/smokeEvent"
operations:
  receiveReading:
    action: receive
    channel:
      $ref: "#/channels/raw-readings"
  sendSmokeEvent:
    action: send
    channel:
      $ref: "#/channels/threshold-readings"
components:
  messages:
    reading:
      name: reading
      title: Raw Sensor Reading
      summary: Raw Sensor Reading from iot device
      payload:
        $ref: "#/components/schemas/readingPayload"
    smokeEvent:
      name: smokeEvent
      title: Smoke Event
      summary: >-
        When certain values inside raw sensor reading pass a configurable
        thresholds
      payload:
        $ref: "#/components/schemas/smokeEvent"
  schemas:
    readingPayload:
      type: object
      required:
        - id
        - timestamp
        - temperature
        - humidity
        - tvoc
        - e_co2
        - raw_hw
        - raw_ethanol
        - pm_25
        - fire_alarm
      properties:
        id:
          type: string
          description: Id of the object in database
        timestamp:
          type: integer
          description: Raw UTC timestamp of the reading
        temperature:
          type: number
          description: Air temperature, fires raise temperature
        humidity:
          type: number
          description: Air humidity, very high or low can indicate fire
        tvoc:
          type: integer
          description: Total Volatile Organic Compounds, high numbers indicate fire
        e_co2:
          type: integer
          description: CO2 equivalent concentration, indirect signal for combustion
        raw_hw:
          type: integer
          description: Raw molecular hydrogen, additional chemical signal
        raw_ethanol:
          type: integer
          description: Raw ethanol gas, additional chemical signal
        pm_25:
          type: number
          description: Particulate matter <2.5 µm, smoke increases concentrations
        fire_alarm:
          type: integer
          description: Ground truth, 1 if fire is present
      example:
        id: 449
        timestamp: 1654733345
        temperature: 20.204
        humidity: 51.17
        tvoc: 0
        e_co2: 403
        raw_hw: 12468
        raw_ethanol: 19338
        pm_25: 2.96
        fire_alarm: 0
    smokeEvent:
      type: object
      required:
        - reading_id
        - timestamp
        - triggers
      properties:
        reading_id:
          type: integer
          description: ReadingId in database
        timestamp:
          type: integer
          description: Raw UTC timestamp of the reading
        triggers:
          type: array
          description: Triggers are field values that passed a certain threshold
          items:
            $ref: "#/components/schemas/trigger"
      example:
        reading_id: 145
        timestamp: 1654733421
        triggers:
          - type: PM25
            value: 87.5
            threshold: 50
          - type: ECO2
            value: 1567
            threshold: 2000
    trigger:
      type: object
      required:
        - type
        - value
        - threshold
      properties:
        type:
          $ref: "#/components/schemas/thresholdType"
        value:
          type: number
          description: Actual sensor value that exceeded the threshold
        threshold:
          type: number
          description: Configured threshold value
    thresholdType:
      type: string
      enum:
        - PM25
        - TVOC
        - ECO2
        - TEMPERATURE
      description: |
        Type of sensor value that exceeded the threshold.
        Possible values:
        - PM25: Particulate matter < 2.5µm
        - TVOC: Total volatile organic compounds
        - ECO2: CO2 equivalent concentration
        - TEMPERATURE: Air temperature
